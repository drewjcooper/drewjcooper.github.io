---
layout: post
title: Exercise 6 (part 5) – Putting our DLL through it’s paces
date: '2011-04-17T23:09:00.001+10:00'
tags:
- C# Specifics
- C# Exercise
- ".NET Specifics"
modified_time: '2011-04-17T23:09:31.863+10:00'
---

<p>Over the last four posts I’ve built up the engine of an RPN calculator in the form of a DLL.&nbsp; Now it’s finaly time to put it use.&nbsp; In this post I’ll present the code for a console-based user interface for our calculator.</p> <a name='more'></a> <p>Before we look at the code I’ll show you you the calculator interface I ended up with.</p><pre style="background-color: black; width: 450px; color: white; margin-left: 2em; font-size: 10px">                                        &lt;0&gt;     0       (Zero)
                                        &lt;1&gt;     1       (One)
4:                                      &lt;2&gt;     2       (Two)
3:                                      &lt;3&gt;     3       (Three)
2:                                      &lt;4&gt;     4       (Four)
1:                                      &lt;5&gt;     5       (Five)
                                        &lt;6&gt;     6       (Six)
_                                       &lt;7&gt;     7       (Seven)
                                        &lt;8&gt;     8       (Eight)
                                        &lt;9&gt;     9       (Nine)
                                        &lt;.&gt;     .       (Decimal)
                                        &lt;E&gt;     E       (Exponent)
                                        &lt;BkSpc&gt; Back    (Back)
                                        &lt;Enter&gt; Enter   (Enter)
                                        &lt;_&gt;     +/-     (Negate)
                                        &lt;\&gt;     1/x     (Inverse)
                                        &lt;p&gt;     π       (PI)
                                        &lt;e&gt;     e       (e)
                                        &lt;+&gt;     +       (Add)
                                        &lt;-&gt;     -       (Subtract)
                                        &lt;*&gt;     x       (Multiply)
                                        &lt;/&gt;     ÷       (Divide)
                                        &lt;%&gt;     mod     (Modulus)
                                        &lt;!&gt;     !       (Factorial)
                                        &lt;c&gt;     cos     (Cosine)
                                        &lt;s&gt;     sin     (Sine)
                                        &lt;t&gt;     tan     (Tangent)
                                        &lt;S&gt;     x²      (Square)
                                        &lt;C&gt;     x3      (Cube)
                                        &lt;R&gt;     √       (SquareRoot)

</pre>
<p>The left side of the console is the calculator display.&nbsp; The top line is used for messages.&nbsp; The four numbered lines are the top four values on the stack.&nbsp; The line with the cursor is the input line.&nbsp; </p>
<p>On the right side of the display are the calculator “buttons”.&nbsp; In this interface they don’t actually do anything – they’re just a visual display of the key options available to the user.&nbsp; The left column is the key-stroke that activates that operation, the middle column is the display text for the button face (this is what would be on the button in a GUI), and the right-hand column is the name of the operation.</p>
<p>And now to the code.&nbsp; In Visual Studio begin a new Console Application project, and add a reference to the DLL.</p>
<div class="csharpcode"><pre><span class="lnum">   1:  </span><span class="kwrd">using</span> System;</pre><pre><span class="lnum">   2:  </span><span class="kwrd">using</span> System.Collections.Generic;</pre><pre><span class="lnum">   3:  </span>&nbsp;</pre><pre><span class="lnum">   4:  </span><span class="kwrd">using</span> LearningCSharp;</pre><pre><span class="lnum">   5:  </span>&nbsp;</pre><pre><span class="lnum">   6:  </span><span class="kwrd">class</span> ConsoleRPNCalculator</pre><pre><span class="lnum">   7:  </span>{</pre><pre><span class="lnum">   8:  </span>    <span class="kwrd">static</span> RPNCalculatorEngine rpnCalcEngine;</pre><pre><span class="lnum">   9:  </span>    <span class="kwrd">static</span> Dictionary&lt;<span class="kwrd">char</span>, <span class="kwrd">int</span>&gt; buttons;</pre><pre><span class="lnum">  10:  </span>&nbsp;</pre></div>
<p>We start with a class for the Console-based calculator UI.&nbsp; The class has static members for the calculator engine, and a dictionary of the “buttons” for the interface.&nbsp; This dictionary maps a key-stroke character to the index of the operation in the calculator engine.&nbsp; <code>Dictionary&lt;char, int&gt;</code> is one of the many pre-defined generics-based collections in the <code>System.Collections.Generic</code> namespace.</p>
<div class="csharpcode"><pre><span class="lnum">  11:  </span>    <span class="kwrd">static</span> <span class="kwrd">private</span> <span class="kwrd">void</span> DrawCalculator()</pre><pre><span class="lnum">  12:  </span>    {</pre><pre><span class="lnum">  13:  </span>        <span class="kwrd">for</span> (<span class="kwrd">int</span> stackIndex = 3; stackIndex &gt;= 0; stackIndex--)</pre><pre><span class="lnum">  14:  </span>        {</pre><pre><span class="lnum">  15:  </span>            Console.SetCursorPosition(0, 5 - stackIndex);</pre><pre><span class="lnum">  16:  </span>            Console.Write(<span class="str">"                         "</span>);</pre><pre><span class="lnum">  17:  </span>            Console.CursorLeft = 0;</pre><pre><span class="lnum">  18:  </span>            Console.WriteLine((stackIndex + 1) + <span class="str">": "</span> + rpnCalcEngine[stackIndex]);</pre><pre><span class="lnum">  19:  </span>        }</pre><pre><span class="lnum">  20:  </span>        Console.SetCursorPosition(0, 7);</pre><pre><span class="lnum">  21:  </span>        Console.Write(<span class="str">"                         "</span>);</pre><pre><span class="lnum">  22:  </span>        Console.SetCursorPosition(0, 7);</pre><pre><span class="lnum">  23:  </span>        Console.Write(rpnCalcEngine.InputString);</pre><pre><span class="lnum">  24:  </span>    }</pre><pre><span class="lnum">  25:  </span>&nbsp;</pre></div>
<p>The <code>DrawCalculator</code> method draws the calculator interface on the left-side of the UI, using the indexer and <code>InputString</code> properties of the calculator engine.&nbsp; This method shows some of the cursor positioning capabilities of the <code>System.Console</code> class.&nbsp; This class also provides full control over text and background colours and the size of the console.&nbsp; It’s easy to create a simple text-based interface that’s not just a scrolling list of input/output.</p>
<div class="csharpcode"><pre><span class="lnum">  26:  </span>    <span class="kwrd">static</span> <span class="kwrd">void</span> DisplayButtons()</pre><pre><span class="lnum">  27:  </span>    {</pre><pre><span class="lnum">  28:  </span>        Console.Clear();</pre><pre><span class="lnum">  29:  </span>        <span class="kwrd">for</span> (<span class="kwrd">int</span> buttonIndex = 0; buttonIndex &lt; buttons.Count; buttonIndex++)</pre><pre><span class="lnum">  30:  </span>        {</pre><pre><span class="lnum">  31:  </span>            RPNCalculatorEngine.Operation operation = rpnCalcEngine.GetOperation(buttonIndex);</pre><pre><span class="lnum">  32:  </span>            Console.SetCursorPosition(40,buttonIndex);</pre><pre><span class="lnum">  33:  </span>            Console.CursorTop = buttonIndex;</pre><pre><span class="lnum">  34:  </span>            <span class="kwrd">string</span> keyName = operation.ShortCut == <span class="str">'\b'</span> ? <span class="str">"BkSpc"</span> : operation.ShortCut == <span class="str">'\r'</span> ? <span class="str">"Enter"</span> : operation.ShortCut.ToString();</pre><pre><span class="lnum">  35:  </span>            Console.Write(<span class="str">"&lt;"</span> + keyName + <span class="str">"&gt;\t"</span> + operation.KeyText + <span class="str">"\t("</span> + operation.Name + <span class="str">")"</span>);</pre><pre><span class="lnum">  36:  </span>        }</pre><pre><span class="lnum">  37:  </span>    }</pre><pre><span class="lnum">  38:  </span>&nbsp;</pre></div>
<p>The <code>DisplayButtons</code> method draws the right-hand side of the interface listing the “buttons” and associated operations, by looping through the list of operations provided by the engine.</p>
<div class="csharpcode"><pre><span class="lnum">  39:  </span>    <span class="kwrd">static</span> <span class="kwrd">void</span> WriteErrorLine(<span class="kwrd">string</span> errorString)</pre><pre><span class="lnum">  40:  </span>    {</pre><pre><span class="lnum">  41:  </span>        Console.SetCursorPosition(0, 0);</pre><pre><span class="lnum">  42:  </span>        Console.Write(errorString);</pre><pre><span class="lnum">  43:  </span>    }</pre><pre><span class="lnum">  44:  </span>&nbsp;</pre></div>
<p>The WriteErrorLine method just writes the given message in the error line of the interface.</p>
<div class="csharpcode"><pre><span class="lnum">  45:  </span>    <span class="kwrd">public</span> <span class="kwrd">static</span> <span class="kwrd">void</span> Main()</pre><pre><span class="lnum">  46:  </span>    {</pre><pre><span class="lnum">  47:  </span>        rpnCalcEngine = <span class="kwrd">new</span> RPNCalculatorEngine();</pre><pre><span class="lnum">  48:  </span>        buttons = <span class="kwrd">new</span> Dictionary&lt;<span class="kwrd">char</span>, <span class="kwrd">int</span>&gt;();</pre><pre><span class="lnum">  49:  </span>        RPNCalculatorEngine.Operation operation;</pre><pre><span class="lnum">  50:  </span>&nbsp;</pre><pre><span class="lnum">  51:  </span>        <span class="kwrd">int</span> i = 0;</pre><pre><span class="lnum">  52:  </span>        <span class="kwrd">bool</span> errorDisplayed = <span class="kwrd">false</span>;</pre><pre><span class="lnum">  53:  </span>        <span class="kwrd">while</span> ((operation = rpnCalcEngine.GetOperation(i)) != <span class="kwrd">null</span>)</pre><pre><span class="lnum">  54:  </span>        {</pre><pre><span class="lnum">  55:  </span>            buttons.Add(operation.ShortCut, i++);</pre><pre><span class="lnum">  56:  </span>        }</pre><pre><span class="lnum">  57:  </span>        DisplayButtons();</pre><pre><span class="lnum">  58:  </span>        <span class="kwrd">do</span></pre><pre><span class="lnum">  59:  </span>        {</pre><pre><span class="lnum">  60:  </span>            DrawCalculator();</pre><pre><span class="lnum">  61:  </span>            <span class="kwrd">int</span> button;</pre><pre><span class="lnum">  62:  </span>            <span class="kwrd">char</span> keyChar = Console.ReadKey(<span class="kwrd">true</span>).KeyChar;</pre><pre><span class="lnum">  63:  </span>            <span class="kwrd">if</span> (keyChar == <span class="str">'\x1b'</span>) <span class="kwrd">break</span>;    <span class="rem">// exit the loop if Escape key pressed</span></pre><pre><span class="lnum">  64:  </span>            <span class="kwrd">if</span> (buttons.TryGetValue(keyChar, <span class="kwrd">out</span> button))</pre><pre><span class="lnum">  65:  </span>            {</pre><pre><span class="lnum">  66:  </span>                <span class="kwrd">try</span></pre><pre><span class="lnum">  67:  </span>                {</pre><pre><span class="lnum">  68:  </span>                    <span class="kwrd">if</span> (errorDisplayed)</pre><pre><span class="lnum">  69:  </span>                    {</pre><pre><span class="lnum">  70:  </span>                        Console.SetCursorPosition(0, 0);</pre><pre><span class="lnum">  71:  </span>                        WriteErrorLine(<span class="str">"                                   "</span>);</pre><pre><span class="lnum">  72:  </span>                        WriteErrorLine(<span class="str">"                                   "</span>);</pre><pre><span class="lnum">  73:  </span>                        DisplayButtons();</pre><pre><span class="lnum">  74:  </span>                        errorDisplayed = <span class="kwrd">false</span>;</pre><pre><span class="lnum">  75:  </span>                    }</pre><pre><span class="lnum">  76:  </span>                    rpnCalcEngine.PressKey(button);</pre><pre><span class="lnum">  77:  </span>                }</pre><pre><span class="lnum">  78:  </span>                <span class="kwrd">catch</span> (FormatException)</pre><pre><span class="lnum">  79:  </span>                {</pre><pre><span class="lnum">  80:  </span>                    WriteErrorLine(<span class="str">"Invalid number format"</span>);</pre><pre><span class="lnum">  81:  </span>                    errorDisplayed = <span class="kwrd">true</span>;</pre><pre><span class="lnum">  82:  </span>                }</pre><pre><span class="lnum">  83:  </span>                <span class="kwrd">catch</span> (Exception e)</pre><pre><span class="lnum">  84:  </span>                {</pre><pre><span class="lnum">  85:  </span>                    WriteErrorLine(e.Message);</pre><pre><span class="lnum">  86:  </span>                    errorDisplayed = <span class="kwrd">true</span>;</pre><pre><span class="lnum">  87:  </span>                }</pre><pre><span class="lnum">  88:  </span>            }</pre><pre><span class="lnum">  89:  </span>        } <span class="kwrd">while</span> (<span class="kwrd">true</span>);</pre><pre><span class="lnum">  90:  </span>    }</pre><pre><span class="lnum">  91:  </span>}</pre></div>
<p>The good old <code>Main</code> method.&nbsp; Here we set up the calculator interface and just run through the main application loop – reading keyboard input, updating the calculator display, and displaying the error messages from any exceptions thrown by the engine.</p>
<p>So that’s it.&nbsp; Next time I’ll have a look at some of the things I’ve been learning in ASP.Net MVC.
  
---
title: Exercise 6 (part 3) – Delegates and Class Inheritance
date: '2011-04-10T21:28:00.001+10:00'
tags:
- C# Specifics
- C# Exercise
- ".NET Specifics"
modified_time: '2011-04-11T11:28:06.748+10:00'
---

<p>So, back to my RPN calculator implementation.&nbsp; Bear in mind that I wrote this code over six months ago, and I’ve learned a lot since then.&nbsp; If I was to do it again now I may make different design decisions, but for the moment I’ll stick with the original code.&nbsp; Let’s see what we can learn.</p> <a name='more'></a> <p>Last post I looked at the <code>InputLine</code> class.&nbsp; A calculator also needs a set of operations it can perform.&nbsp; An operation can be an input operation, or can take 0, 1 or 2 operands from the operand stack (constant, unary or binary operation) and returns a value to the stack.&nbsp; Each operation is bound to a key on the calculator interface.</p> <p>First things first, though.</p> <div class="csharpcode"><pre><span class="lnum">   1:  </span><span class="kwrd">using</span> System;</pre><pre><span class="lnum">   2:  </span><span class="kwrd">using</span> System.Collections.Generic;</pre><pre><span class="lnum">   3:  </span>&nbsp;</pre><pre><span class="lnum">   4:  </span><span class="kwrd">namespace</span> LearningCSharp</pre><pre><span class="lnum">   5:  </span>{</pre><pre><span class="lnum">   6:  </span>    <span class="kwrd">public</span> <span class="kwrd">partial</span> <span class="kwrd">class</span> RPNCalculatorEngine</pre><pre><span class="lnum">   7:  </span>    {</pre><pre><span class="lnum">   8:  </span>        <span class="kwrd">public</span> <span class="kwrd">delegate</span> <span class="kwrd">double</span> BinaryOp(<span class="kwrd">double</span> operand1, <span class="kwrd">double</span> operand2);</pre><pre><span class="lnum">   9:  </span>        <span class="kwrd">public</span> <span class="kwrd">delegate</span> <span class="kwrd">double</span> UnaryOp(<span class="kwrd">double</span> operand);</pre><pre><span class="lnum">  10:  </span>&nbsp;</pre></div>
<p>I declare a couple of <strong>delegate</strong> types, <code>BinaryOp</code> and <code>UnaryOp</code>.&nbsp; A <strong>delegate</strong> is similar to a function pointer in C.&nbsp; It basically gives you a way to refer to a method and pass it around to get stuff done.&nbsp; A variable of type <code>BinaryOp </code>can refer to a method that takes two <strong>double</strong> parameters and return a <strong>double</strong>.&nbsp; A <code>UnaryOp </code>takes one <strong>double</strong> parameter and returns a <strong>double</strong>.&nbsp; We’ll see these delegate types in use in a minute.</p>
<div class="csharpcode"><pre><span class="lnum">  11:  </span>        <span class="kwrd">public</span> <span class="kwrd">class</span> Operation</pre><pre><span class="lnum">  12:  </span>        {</pre><pre><span class="lnum">  13:  </span>            <span class="kwrd">protected</span> <span class="kwrd">readonly</span> <span class="kwrd">string</span> _name;</pre><pre><span class="lnum">  14:  </span>            <span class="kwrd">protected</span> <span class="kwrd">readonly</span> <span class="kwrd">string</span> _abbreviation;</pre><pre><span class="lnum">  15:  </span>            <span class="kwrd">protected</span> <span class="kwrd">readonly</span> <span class="kwrd">string</span> _keyText;</pre><pre><span class="lnum">  16:  </span>            <span class="kwrd">protected</span> <span class="kwrd">readonly</span> <span class="kwrd">char</span> _keyboardShortCut;</pre><pre><span class="lnum">  17:  </span>            <span class="kwrd">protected</span> <span class="kwrd">readonly</span> <span class="kwrd">int</span> _operandsRequired;</pre><pre><span class="lnum">  18:  </span>&nbsp;</pre><pre><span class="lnum">  19:  </span>            <span class="kwrd">public</span> Operation(<span class="kwrd">string</span> name, <span class="kwrd">string</span> abbr, <span class="kwrd">string</span> keyText, <span class="kwrd">char</span> keyboardShortCut, <span class="kwrd">int</span> operandsRequired = 0)</pre><pre><span class="lnum">  20:  </span>            {</pre><pre><span class="lnum">  21:  </span>                _name = name;</pre><pre><span class="lnum">  22:  </span>                _abbreviation = abbr;</pre><pre><span class="lnum">  23:  </span>                _keyText = keyText;</pre><pre><span class="lnum">  24:  </span>                _keyboardShortCut = keyboardShortCut;</pre><pre><span class="lnum">  25:  </span>                _operandsRequired = operandsRequired;</pre><pre><span class="lnum">  26:  </span>            }</pre><pre><span class="lnum">  27:  </span>&nbsp;</pre><pre><span class="lnum">  28:  </span>            <span class="kwrd">public</span> <span class="kwrd">string</span> Name { get { <span class="kwrd">return</span> _name; } }</pre><pre><span class="lnum">  29:  </span>            <span class="kwrd">public</span> <span class="kwrd">string</span> Abbreviation { get { <span class="kwrd">return</span> _abbreviation; } }</pre><pre><span class="lnum">  30:  </span>            <span class="kwrd">public</span> <span class="kwrd">string</span> KeyText { get { <span class="kwrd">return</span> _keyText; } }</pre><pre><span class="lnum">  31:  </span>            <span class="kwrd">public</span> <span class="kwrd">char</span> ShortCut { get { <span class="kwrd">return</span> _keyboardShortCut; } }</pre><pre><span class="lnum">  32:  </span>            <span class="kwrd">public</span> <span class="kwrd">virtual</span> <span class="kwrd">bool</span> HasFunction { get { <span class="kwrd">return</span> <span class="kwrd">false</span>; } }</pre><pre><span class="lnum">  33:  </span>&nbsp;</pre><pre><span class="lnum">  34:  </span>            <span class="kwrd">public</span> <span class="kwrd">virtual</span> <span class="kwrd">void</span> Execute(Stack&lt;<span class="kwrd">double</span>&gt; operands) { }</pre><pre><span class="lnum">  35:  </span>        }</pre><pre><span class="lnum">  36:  </span>&nbsp;</pre></div>
<p>In this design, an <strong>Operation</strong> is something that happens based on user interaction with the calculator interface.&nbsp; Above is the<strong> </strong><code>Operation</code> class, which is the base class for all Operations.&nbsp; The <strong>class</strong> includes read-only <strong>fields</strong> for the name, abbreviation, text to display on calculator interface (<code>_keyText</code>), keyboard shortcut to bind to the operation (<code>_keyboardShortCut</code>), and the number of operands required, if any, for the operation.</p>
<p>Declaring a <strong>field</strong> as <code>readonly</code> means that it can only be set during object instantiation, that is, in the constructor.&nbsp; As there’s no way to modify the object once it’s been created, an <code>Operation</code> object is immutable.&nbsp; Declaring the fields as <code>protected</code> means that they can only be accessed directly by code within this class, or any class derived from this class.</p>
<p>The <strong>class</strong> also defines some public <strong>properties</strong> that give access to the values stored in the fields to code outside of the class.&nbsp; Note that <code>_operandsRequired</code> doesn’t have an associated <strong>property</strong>, so it’s only available within the class, or those derived from it.&nbsp; Note also the <code>HasFunction</code> property, which in this class returns <code>false</code>.&nbsp; The purpose of this property is to indicate to client code whether or not this <strong>operation</strong> has a function associated with it.&nbsp; The <strong>property</strong> is declared <code>virtual</code> so that it can be overridden by classes which derive from <code>Operation</code>.</p>
<p>Finally, the class has a <strong>virtual method</strong> called <code>Execute</code>, which in this case does nothing.&nbsp; In derived classes it will be overridden to execute the function associated with the <strong>operation</strong>.</p>
<div class="csharpcode"><pre><span class="lnum">  37:  </span>        <span class="kwrd">public</span> <span class="kwrd">class</span> BinaryOperation : Operation</pre><pre><span class="lnum">  38:  </span>        {</pre><pre><span class="lnum">  39:  </span>&nbsp;</pre><pre><span class="lnum">  40:  </span>            <span class="kwrd">private</span> <span class="kwrd">readonly</span> BinaryOp _function;</pre><pre><span class="lnum">  41:  </span>&nbsp;</pre><pre><span class="lnum">  42:  </span>            <span class="kwrd">public</span> BinaryOperation(<span class="kwrd">string</span> name, <span class="kwrd">string</span> abbr, <span class="kwrd">string</span> keyText, <span class="kwrd">char</span> keyBoardShortCut, BinaryOp func)</pre><pre><span class="lnum">  43:  </span>                : <span class="kwrd">base</span>(name, abbr, keyText, keyBoardShortCut, 2)</pre><pre><span class="lnum">  44:  </span>            {</pre><pre><span class="lnum">  45:  </span>                _function = func;</pre><pre><span class="lnum">  46:  </span>            }</pre><pre><span class="lnum">  47:  </span>&nbsp;</pre><pre><span class="lnum">  48:  </span>            <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">bool</span> HasFunction { get { <span class="kwrd">return</span> <span class="kwrd">true</span>; } }</pre><pre><span class="lnum">  49:  </span>            </pre><pre><span class="lnum">  50:  </span>            <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">void</span> Execute(Stack&lt;<span class="kwrd">double</span>&gt; operands)</pre><pre><span class="lnum">  51:  </span>            {</pre><pre><span class="lnum">  52:  </span>                <span class="kwrd">if</span> (operands.Count &lt; _operandsRequired)</pre><pre><span class="lnum">  53:  </span>                {</pre><pre><span class="lnum">  54:  </span>                    <span class="kwrd">throw</span> <span class="kwrd">new</span> ArgumentException(_abbreviation + <span class="str">": Insufficient operands"</span>);</pre><pre><span class="lnum">  55:  </span>                }</pre><pre><span class="lnum">  56:  </span>                operands.Push(_function(operands.Pop(), operands.Pop()));</pre><pre><span class="lnum">  57:  </span>            }</pre><pre><span class="lnum">  58:  </span>        }</pre><pre><span class="lnum">  59:  </span>&nbsp;</pre></div>
<p>Here’s the definition of the <code>BinaryOperation</code> class.&nbsp; Line 37 declares the class to be derived from the <code>Operation</code> class (<code>: Operation</code>), so <code>BinaryOperation</code> inherits all of <code>Operation</code>’s public and protected members (fields, properties, methods, etc).</p>
<p><code>BinaryOperation</code> adds a new field to store a function to be performed by the operation.&nbsp; Note that the type of this member is one of the <strong>delegate</strong> types we declared earlier.&nbsp; So, an object of the <code>BinaryOperation</code> class will store a reference to a procedure that accepts two <code>double</code> parameters, and returns a <code>double</code> result.</p>
<p>The constructor here takes a form that we haven’t seen before.</p><pre class="csharpcode"><span class="kwrd">public</span> BinaryOperation(<span class="kwrd">string</span> name, <span class="kwrd">string</span> abbr, <span class="kwrd">string</span> keyText, <span class="kwrd">char</span> keyBoardShortCut, BinaryOp func)
    : <span class="kwrd">base</span>(name, abbr, keyText, keyBoardShortCut, 2)</pre>
<p>The constructor’s signature is similar to that of the <code>Operation</code> constructor, except that instead of a parameter for the number of operands it accepts a delegate for the function to be associated with this operation.&nbsp; The next line defines the <strong>constructor initialiser</strong>.&nbsp; By default, all instance constructors (except for <code>object</code>) call the parameterless constructor of the base class (<code>base()</code>) before executing the body of the constructor.&nbsp; This allows the base class to handle the construction of its bit so the derived class doesn’t have to worry about it.&nbsp; In this case we change the default behaviour by specifying the <strong>constructor initialiser</strong> explicitly.&nbsp; This basically passes most of the parameters through to the <code>Operation</code> constructor, including the specification of the number of operands needed for this operation.&nbsp; The body of the constructor then initialises the only thing specific to this class, the <code>_function</code> field.</p>
<p>In order for the calculator to be able to make use of this function the <code>BinaryOperator</code> class overrides the <code>Execute</code> method from <code>Operation</code>.&nbsp; The calculator engine passes the operand stack to the Execute method.&nbsp; The method checks that there are sufficient operands on the stack, and throws an exception if not.&nbsp; The exception includes an error message that can be used by the calculator engine.</p>
<p>If there are enough operands on the stack, <code>Execute</code> pop’s the top two operands, calls the function stored in the operation, and then pushes the result onto the stack.&nbsp; Pretty simple.</p>
<div class="csharpcode"><pre><span class="lnum">  60:  </span>        <span class="kwrd">public</span> <span class="kwrd">class</span> UnaryOperation : Operation</pre><pre><span class="lnum">  61:  </span>        {</pre><pre><span class="lnum">  62:  </span>&nbsp;</pre><pre><span class="lnum">  63:  </span>            <span class="kwrd">private</span> <span class="kwrd">readonly</span> UnaryOp _function;</pre><pre><span class="lnum">  64:  </span>&nbsp;</pre><pre><span class="lnum">  65:  </span>            <span class="kwrd">public</span> UnaryOperation(<span class="kwrd">string</span> name, <span class="kwrd">string</span> abbr, <span class="kwrd">string</span> keyText, <span class="kwrd">char</span> keyBoardShortCut, UnaryOp func)</pre><pre><span class="lnum">  66:  </span>                : <span class="kwrd">base</span>(name, abbr, keyText, keyBoardShortCut, 1)</pre><pre><span class="lnum">  67:  </span>            {</pre><pre><span class="lnum">  68:  </span>                _function = func;</pre><pre><span class="lnum">  69:  </span>            }</pre><pre><span class="lnum">  70:  </span>&nbsp;</pre><pre><span class="lnum">  71:  </span>            <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">bool</span> HasFunction { get { <span class="kwrd">return</span> <span class="kwrd">true</span>; } }</pre><pre><span class="lnum">  72:  </span>&nbsp;</pre><pre><span class="lnum">  73:  </span>            <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">void</span> Execute(Stack&lt;<span class="kwrd">double</span>&gt; operands)</pre><pre><span class="lnum">  74:  </span>            {</pre><pre><span class="lnum">  75:  </span>                <span class="kwrd">if</span> (operands.Count &lt; _operandsRequired)</pre><pre><span class="lnum">  76:  </span>                {</pre><pre><span class="lnum">  77:  </span>                    <span class="kwrd">throw</span> <span class="kwrd">new</span> ArgumentException(_abbreviation + <span class="str">": Insufficient operands"</span>);</pre><pre><span class="lnum">  78:  </span>                }</pre><pre><span class="lnum">  79:  </span>                operands.Push(_function(operands.Pop()));</pre><pre><span class="lnum">  80:  </span>            }</pre><pre><span class="lnum">  81:  </span>        }</pre><pre><span class="lnum">  82:  </span>&nbsp;</pre></div>
<p>The <code>UnaryOperation</code> class loos very similar to <code>BinaryOperation</code>.&nbsp; The basic differences are the delegate type passed to the constructor, the number of required operands passed to the base constructor, and operation of the <code>Execute</code> method.&nbsp; In this class <code>Execute</code> pops a single operand off the stack and returns the result of the function to the stack.</p>
<div class="csharpcode"><pre><span class="lnum">  83:  </span>        <span class="kwrd">public</span> <span class="kwrd">class</span> ConstantOperation : Operation</pre><pre><span class="lnum">  84:  </span>        {</pre><pre><span class="lnum">  85:  </span>&nbsp;</pre><pre><span class="lnum">  86:  </span>            <span class="kwrd">private</span> <span class="kwrd">readonly</span> <span class="kwrd">double</span> _value;</pre><pre><span class="lnum">  87:  </span>&nbsp;</pre><pre><span class="lnum">  88:  </span>            <span class="kwrd">public</span> ConstantOperation(<span class="kwrd">string</span> name, <span class="kwrd">string</span> abbr, <span class="kwrd">string</span> keyText, <span class="kwrd">char</span> keyBoardShortCut, <span class="kwrd">double</span> <span class="kwrd">value</span>)</pre><pre><span class="lnum">  89:  </span>                : <span class="kwrd">base</span>(name, abbr, keyText, keyBoardShortCut, 0)</pre><pre><span class="lnum">  90:  </span>            {</pre><pre><span class="lnum">  91:  </span>                _value = <span class="kwrd">value</span>;</pre><pre><span class="lnum">  92:  </span>            }</pre><pre><span class="lnum">  93:  </span>&nbsp;</pre><pre><span class="lnum">  94:  </span>            <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">bool</span> HasFunction { get { <span class="kwrd">return</span> <span class="kwrd">true</span>; } }</pre><pre><span class="lnum">  95:  </span>&nbsp;</pre><pre><span class="lnum">  96:  </span>            <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">void</span> Execute(Stack&lt;<span class="kwrd">double</span>&gt; operands)</pre><pre><span class="lnum">  97:  </span>            {</pre><pre><span class="lnum">  98:  </span>                operands.Push(_value);</pre><pre><span class="lnum">  99:  </span>            }</pre><pre><span class="lnum"> 100:  </span>        }</pre><pre><span class="lnum"> 101:  </span>    }</pre><pre><span class="lnum"> 102:  </span>}</pre></div>
<p>The <code>ConstantOperation</code> class is similar to the two above except that instead of a function delegate, it stores a constant value.&nbsp; The <code>Execute</code> method just pushes that value onto the operand stack.</p>
<p>So there we are, we’ve looked at the implementation of the Operations and the InputLine for the calculator.&nbsp; Next time we’ll look at the rest of the calculator engine and see how all this ties together.</p>
<p>Before I go, though, a couple of notes on the way this design would change if I were doing it today.&nbsp; Since I designed these classes I’ve been learning a lot about the .Net framework.&nbsp; In the <code>System</code> namespace are a bunch of classes which use generics to define easy to use delegates.&nbsp; Instead of declaring the <code>BinaryOp</code> and <code>UnaryOp</code> delegates we can use <code>Func&lt;double, double, double&gt;</code> and <code>Func&lt;double, double&gt;</code>.&nbsp; And for consistency we could use <code>Func&lt;double&gt;</code> instead of the value parameter for the <code>ConstantOperation</code> class.&nbsp; </p>
<p>See you next time.</p>  